<!DOCTYPE html><html><head><meta charset="utf-8"><title>ARP 地址解析协议 | LOVAE BLOG</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="Lovae"><meta name="designer" content="minfive"><meta name="keywords" content="lovae, shichao blog, 前端博客, 前端, 程序员, 前端开发, 全栈开发, node.js, javascript, 后台, golang, 网络编程"><meta name="description" content="日常学习与兴趣交流的个人博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://littlechao.top/2018/06/12/arp/index.html"><link rel="icon" type="image/png" href="https://image.littlechao.top/20180512113931000007.jpg" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="Hexo"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(http://oo12ugek5.bkt.clouddn.com/blog/images/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="Hexo" alt="Hexo"><img src="https://image.littlechao.top/20180506131200000003.jpg" alt="Hexo"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/images/ip/ip.jpg" alt="ARP 地址解析协议"></div><header class="post__info"><h1 class="post__title">ARP 地址解析协议</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">Lovae</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-06-12</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/IP/">IP</a></li></ul></div></div></header><div class="post__content"><h2 id="ARP-协议"><a href="#ARP-协议" class="headerlink" title="ARP 协议"></a>ARP 协议</h2><blockquote><p>在网络通信中，主机和主机通信的数据包需要依据OSI模型从上到下进行数据封装，当数据封装完整后，再向外发出。所以在局域网的通信中，不仅需要源目IP地址的封装，也需要源目MAC的封装。上层应用程序更多关心IP地址而不关心MAC地址，所以需要通过ARP协议来获知目的主机的MAC地址</p><p>IP 协议使得报文可以跨越不同网络进行传输，当 IP 报文到达目标地址所在网络后，接下来要靠对方的 Mac 地址才能交付，这时候也要用到 ARP 地址解析协议。</p></blockquote><h3 id="ARP-原理"><a href="#ARP-原理" class="headerlink" title="ARP 原理"></a>ARP 原理</h3><h4 id="请求与应答"><a href="#请求与应答" class="headerlink" title="请求与应答"></a>请求与应答</h4><p>我在 Mac 上使用 ping 命令查询 192.168.0.105，由于不知道对方的 Mac 地址，所以先 ARP 请求。抓到的 ARP 请求报文如下：</p><p><img src="/images/ip/arp_req.png" alt=""></p><p>不知道对方是否存在以及在哪里，所以向所在网段发送链路层广播请求，询问谁是 192.168.0.105 ，也就是目标 Mac 地址为 ff:ff:ff:ff:ff:ff，并且带上自己的 IP 和 Mac 信息。响应报文如下：</p><p><img src="/images/ip/arp_res.png" alt=""></p><p>IP 地址为 ARP 目标 IP 地址的主机收到后，由于知道这个请求是谁发出的，就以单播的形式返回一个响应报文，并且告诉对方自己的 Mac 地址。其他主机收到 ARP 请求会默认丢弃。</p><p>请求方收到响应后，即可把目标 Mac 地址封装到帧里然后发送数据。</p><h4 id="ARP-缓存"><a href="#ARP-缓存" class="headerlink" title="ARP 缓存"></a>ARP 缓存</h4><p>为了提高效率，每个主机维护了一个 ARP 缓存，维护着从网络层地址到硬件地址的最新映射，每条映射有一个到期时间，默认是 20min。</p><p>当收到多条 ARP 回应的时候，ARP 缓存按照”后到优先”原则，新的缓存直接覆盖旧的。</p><h3 id="ARP-攻击"><a href="#ARP-攻击" class="headerlink" title="ARP 攻击"></a>ARP 攻击</h3><h4 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h4><p>正常主机收到 ARP 请求，如果 目标 IP 不是自己，那么丢弃此报文。但当存在恶意节点时，则会造成 ARP 攻击：</p><p><img src="/images/ip/arp_attack.png" alt=""></p><p>恶意节点会发送大量的 ARP 响应，由于“后到覆盖”原则，几乎总是拿到错误数据。那么主机 A 会把发给主机 B 的数据都发送给 主机 C。同理，如果主机 B 要发送数据给主机 A，那么 C 也会冒充 A，就形成了 A &lt;=&gt; C &lt;=&gt; B 的情形，这就是典型的<em>中间人攻击</em>。</p><p>更严重的情况是，恶意节点冒充网关，拦截所有流量，这时候恶意节点可以直接使别的主机断连，当然很容易被发现，所以更多的时候实行限速。最严重的是，可能会盗取个人信息和密码。</p><h4 id="防御-ARP-攻击"><a href="#防御-ARP-攻击" class="headerlink" title="防御 ARP 攻击"></a>防御 ARP 攻击</h4><blockquote><p><strong>ARP防御可以在网络设备上实现，也可以在用户端实现，更可以在网络设备和用户端同时实现</strong></p></blockquote><h5 id="网络设备防御"><a href="#网络设备防御" class="headerlink" title="网络设备防御"></a>网络设备防御</h5><p>先来了解下网络设备（例如这里的交换机）的防御技术，这种防御技术被称为<strong>DAI（Dynamic ARP Inspection）- 动态ARP检测</strong>，原理可以用两句话简单概括：</p><ul><li>交换机记录每个接口对应的 IP 地址和 MAC，即 <strong>port&lt;=&gt;mac&lt;=&gt;ip</strong>，生成DAI检测表；</li><li>交换机检测每个接口发送过来的 ARP 回应包，根据 DAI 表判断是否违规，若违规则丢弃此数据包并对接口进行惩罚</li></ul><p>如果判断出包是虚假的欺骗包，交换机马上丢弃这个包，并且可以对接口做惩罚（不同设备的惩罚方式有所不同，可以直接将接口”<strong>软关闭</strong>“，直接将攻击者断网；也可以”<strong>静默处理</strong>“，仅丢弃欺骗包，其他通信正常）</p><p>对于这个方案，有几点问题：</p><ul><li><p>交换机可以查看 IP ？</p><p>从现在的网络技术来看，分层界限越来越模糊，融合式的网络设备才是主流，现在的接入交换机基本能被Telnet/SSH/Web管理。不要被”交换机就是二层设备”给束缚了</p></li></ul><ul><li><p>如何生成 DAI 表 ？</p><p>在交换机上开启<strong>DHCP侦听</strong>技术，当用户第一次通过DHCP获取到地址的时候，交换机就把用户电脑的IP、MAC、Port信息记录在DHCP侦听表，后面ARP检测直接调用这张DHCP侦听表即可</p></li></ul><h5 id="主机防御"><a href="#主机防御" class="headerlink" title="主机防御"></a>主机防御</h5><p>主机有两种方法防御：</p><ul><li>安装 ARP 防火墙</li><li>静态绑定：静态绑定的信息比动态学习的优先级高</li></ul><h3 id="代理-ARP-PARP"><a href="#代理-ARP-PARP" class="headerlink" title="代理 ARP(PARP)"></a>代理 ARP(PARP)</h3><p>在发送数据包时需要填写目标 Mac 地址，可是如果源主机和目标主机不在同一个网络会如何？如图，client 向 Server 发送请求，client 上配置了默认网关。</p><p><img src="/images/ip/arp_non_proxy.png" alt=""></p><p>那么 client 上包的目标 Mac 填什么呢？很显然不可能知道 Server 的 Mac 地址：</p><ul><li>路由器隔离广播域，每个接口/网段都是独立的广播域</li><li>ARP 请求是二层广播包，广播包没法过路由器</li></ul><p>此时如果 client 上配置了默认网关，那么直接找到默认网关的 Mac 地址作为目标地址。</p><p>但如果没有默认网关，则采用<em>代理 ARP</em>。</p><blockquote><p>代理 ARP 本质上是一种欺骗，原理和 ARP 攻击一样，冒充目标地址，不过目的是为了正常通信</p></blockquote><p><img src="/images/ip/arp_proxy.png" alt=""></p><p>在这种情况下，路由器上如果配置了代理 ARP，则会冒充目的地址。</p><p>总结如下：</p><p><strong>①当电脑没有网关（采用代理ARP）时：”跨网段访问谁，就问谁的MAC”</strong></p><p><strong>②当电脑有网关（采用正常ARP）时：”跨网段访问谁，都问网关的MAC”</strong></p><p><strong>③无论哪种ARP，跨网段通信时，发送方请求得到的目标MAC地址都是网关MAC。</strong></p><h3 id="免费-无故-ARP-Gratuitous-ARP"><a href="#免费-无故-ARP-Gratuitous-ARP" class="headerlink" title="免费/无故 ARP(Gratuitous ARP)"></a>免费/无故 ARP(Gratuitous ARP)</h3><p><strong>用于检测局域网内的IP地址冲突</strong>，在一定程度上能够给用户和网络运维人员提供帮助。相比『免费』这个翻译，『无故』这个词其实会更加好理解：”<strong>在没有人问自己的情况下，无缘无故自问自答</strong>“。</p><p>如下是我的电脑和隔壁老王的电脑一起设置了静态 IP 地址，都设成 192.168.0.108，抓到的包：</p><p><img src="/images/ip/gratuitous_arp.png" alt=""></p><p>先看第四条，我的电脑设了静态 IP 后，广播发送无故 ARP，注意这里 tell 后面是 0.0.0.0，也就是说，不用告诉我谁是 192.168.0.108，只是我自己宣告，我就是 192.168.0.108。</p><p>再看第五条，这不是一个 ARP 响应，而是老王的电脑也在向外宣告，他自己是 192.168.0.108，可以看到下面详细信息里目标 Mac 地址是老王的(72结尾的)。我这里收到后，告诉他我才是 192.168.0.108。</p><p>然后两台机器就开始互怼，同一局域网的其他主机，则根据这两个免费 ARP 信息不断的修改本地 ARP 表。</p><p>之后老王把他的 IP 改回 DHCP（第二个红框），路由器(192.168.0.1)这里同时扮演了 DHCP 的分配者，它向外询问是否有人占用了 192.168.0.104 这个地址，没有收到回应，于是分配给老王这个地址。分配了地址后，老王还是要向外宣告他自己的身份，使得同局域网的主机刷新 ARP 缓存，同时检测是否还有地址冲突。</p><p>第三个红框是老王关闭 WIFI 又重启。</p><h3 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h3><p>讨论了三种 ARP：</p><ul><li>ARP：通过 IP 地址找到 Mac 地址</li><li>PARP：在没有网关的时候辅助通信</li><li>GARP：解决地址冲突的问题</li></ul><p>其实还有 RARP(Reverse ARP) 和 IARP(Inverse ARP)，不过使用极少，就不再赘述。</p><div class="post-announce">Thank you for reading, this article belongs to <a href="http://littlechao.top">Hexo</a> copyright, if reproduced, please indicate the source：Hexo（<a href="http://littlechao.top/2018/06/12/arp/">http://littlechao.top/2018/06/12/arp/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2018/06/10/internet_protocol/" title="IP(II) 协议"><i class="iconfont icon-prev"></i>IP(II) 协议</a></div><div class="post__prev post__prev--right"></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">日常学习与兴趣交流的个人博客</p></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/network-protocol/">network protocol</a><span class="block-list-count">9</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/netstack-tcp/">netstack_tcp</a><span class="block-list-count">4</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/06/12/arp/" title="ARP 地址解析协议"><div class="item__cover"><img src="/images/ip/ip.jpg" alt="ARP 地址解析协议"></div><div class="item__info"><h3 class="item__title">ARP 地址解析协议</h3><span class="item__text">2018-06-12</span></div></a></li><li class="latest-post-item"><a href="/2018/06/10/internet_protocol/" title="IP(II) 协议"><div class="item__cover"><img src="/images/ip/ip.jpg" alt="IP(II) 协议"></div><div class="item__info"><h3 class="item__title">IP(II) 协议</h3><span class="item__text">2018-06-10</span></div></a></li><li class="latest-post-item"><a href="/2018/06/04/ip_addr/" title="IP(I) 地址"><div class="item__cover"><img src="/images/ip/ip.jpg" alt="IP(I) 地址"></div><div class="item__info"><h3 class="item__title">IP(I) 地址</h3><span class="item__text">2018-06-04</span></div></a></li><li class="latest-post-item"><a href="/2018/06/02/go_http_server_3/" title="Go http server (III)"><div class="item__cover"><img src="/images/http/go_web_cover.jpg" alt="Go http server (III)"></div><div class="item__info"><h3 class="item__title">Go http server (III)</h3><span class="item__text">2018-06-02</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/IP/">IP</a></li><li class="tag-item"><a class="tag-link" href="/tags/Intellij/">Intellij</a></li><li class="tag-item"><a class="tag-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-item"><a class="tag-link" href="/tags/dart/">dart</a></li><li class="tag-item"><a class="tag-link" href="/tags/golang/">golang</a></li><li class="tag-item"><a class="tag-link" href="/tags/net/">net</a></li><li class="tag-item"><a class="tag-link" href="/tags/netstack/">netstack</a></li><li class="tag-item"><a class="tag-link" href="/tags/node/">node</a></li><li class="tag-item"><a class="tag-link" href="/tags/react/">react</a></li><li class="tag-item"><a class="tag-link" href="/tags/redux/">redux</a></li><li class="tag-item"><a class="tag-link" href="/tags/tcp/">tcp</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Baoding, Hebei Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>shichao1996@gmail.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="https://image.littlechao.top/20180512113439000006.jpg" alt="logo" title="Hexo"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.</p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>