<!DOCTYPE html><html><head><meta charset="utf-8"><title>DHCP 和自动配置 | LOVAE BLOG</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="Lovae"><meta name="designer" content="minfive"><meta name="keywords" content="lovae, shichao blog, 前端博客, 前端, 程序员, 前端开发, 全栈开发, node.js, javascript, 后台, golang, 网络编程"><meta name="description" content="日常学习与兴趣交流的个人博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://littlechao.top/2018/06/17/dhcp/index.html"><link rel="icon" type="image/png" href="https://image.littlechao.top/20180512113931000007.jpg" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="Hexo"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(http://oo12ugek5.bkt.clouddn.com/blog/images/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="Hexo" alt="Hexo"><img src="https://image.littlechao.top/20180506131200000003.jpg" alt="Hexo"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="Home" title="Home">Home</a></li><li class="nav__item"><a href="/archives" alt="Archive" title="Archive">Archive</a></li><li class="nav__item"><a href="/about" alt="About" title="About">About</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/images/ip/ip.jpg" alt="DHCP 和自动配置"></div><header class="post__info"><h1 class="post__title">DHCP 和自动配置</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">Lovae</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-06-17</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/IP/">IP</a></li></ul></div></div></header><div class="post__content"><h2 id="DHCP-和自动配置"><a href="#DHCP-和自动配置" class="headerlink" title="DHCP 和自动配置"></a>DHCP 和自动配置</h2><blockquote><p>为了使用 TCP/IP 协议族，每台主机都要有一定的配置信息，特别是 IP 地址。通常这些配置信息有三种方法获得：</p><ul><li>手工获取</li><li>通过一个系统服务获得</li><li>通过某种算法获得</li></ul></blockquote><p>手工获取就是静态配置 IP、DNS 等信息，主要讨论后两种方法。</p><h3 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h3><p>动态主机配置协议（Dynamic Host Configuration Protocol，DHCP），它动态的分配 IP 地址和其他信息（子网掩码、路由器 IP 地址、DNS 服务器 IP 地址）给主机。DHCP 的设计基于早期的 Internet 引导程序协议(BOOTP)，它使用<em>租用</em>的概念来扩展 BOOTP，允许客户机使用一个商定好的时间来配置信息。通常客户端使用 68 端口，服务端使用 67 端口。</p><p>租用的时间是一个重要的配置参数。如果时间太短，可以提供一个可用性较高的地址池，但频繁的分配导致稳定性减小、网络流量负荷增大；较长的租期稳定性较好，但通常会较快耗尽可用地址。默认的租期在 12~24 小时，在租期过半时，客户端可以申请续租。</p><h4 id="DHCPv4-和-BOOTP"><a href="#DHCPv4-和-BOOTP" class="headerlink" title="DHCPv4 和 BOOTP"></a>DHCPv4 和 BOOTP</h4><p>DHCP 是基于 BOOTP 的，并且 DHCPv4 是兼容 BOOTP 的，BOOTP 消息格式如下：</p><p><img src="/images/ip/bootp.png" alt=""></p><h5 id="基本字段"><a href="#基本字段" class="headerlink" title="基本字段"></a>基本字段</h5><table><thead><tr><th style="text-align:center">字段</th><th>含义</th></tr></thead><tbody><tr><td style="text-align:center">yiaddr</td><td>从 server 送回 client 之 DHCP OFFER 与 DHCPACK 封包中，此栏填写分配给 client 的 IP 地址。</td></tr><tr><td style="text-align:center">TRANSACTION ID</td><td>DHCP REQUEST 时产生的数值，以作 DHCPREPLY 时的依据。</td></tr><tr><td style="text-align:center">sname</td><td>Server 之名称字符串，以 0x00 结尾。</td></tr><tr><td style="text-align:center">siaddr</td><td>若 client 需要透过网络开机，从 server 送出之 DHCP OFFER、DHCPACK、DHCPNACK封包中，此栏填写开机程序代码所在 server 之地址。</td></tr><tr><td style="text-align:center">SECONDS</td><td>Client 端启动时间（秒）。（时间戳）</td></tr><tr><td style="text-align:center">options</td><td>允许厂商定议选项（Vendor-Specific Area)，以提供更多的设定信息（如：Netmask、Gateway、DNS、等等）。</td></tr><tr><td style="text-align:center">OP</td><td>若是 client 送给 server 的封包，设为 1 ，反向为 2。</td></tr><tr><td style="text-align:center">HTYPE</td><td>硬件类别，Ethernet 为 1。</td></tr><tr><td style="text-align:center">HOPS</td><td>若封包需经过 router 传送，每站加 1 ，若在同一网内，为 0。</td></tr><tr><td style="text-align:center">HLEN</td><td>硬件地址长度， Ethernet 为 6。</td></tr><tr><td style="text-align:center">giaddr</td><td>若需跨网域进行 DHCP 发放，此栏为 relay agent 的地址，否则为 0。</td></tr><tr><td style="text-align:center">FLAGS</td><td>从 0 到 15 共 16 bits ，最左一 bit 为 1 时表示 server 将以广播方式传送封包给 client ，其余尚未使用。</td></tr><tr><td style="text-align:center">file</td><td>若 client 需要透过网络开机，此栏将指出开机程序名称，稍后以 TFTP 传送。</td></tr><tr><td style="text-align:center">ciaddr</td><td>要是 client 端想继续使用之前取得之 IP 地址，则列于这里。</td></tr><tr><td style="text-align:center">chaddr</td><td>Client 之硬件地址。</td></tr></tbody></table><h5 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h5><p>DHCP 通过选项来扩展 BOOTP，选项用于携带 IP 地址之外的信息，如 子网掩码、路由器地址、DNS 地址 等等，其中还有一个消息类型选项，表明一个 BOOTP 报文是哪种 DHCP 消息：</p><ul><li>DHCP DISCOVER</li><li>DHCP OFFER</li><li>DHCP REQUEST</li><li>DHCP DECLINE</li><li>DHCP ACK</li><li>DHCP NACK</li><li>DHCP RELEASE</li></ul><h4 id="DHCP-操作过程"><a href="#DHCP-操作过程" class="headerlink" title="DHCP 操作过程"></a>DHCP 操作过程</h4><p>DHCP 消息是带有一组特殊选项的 BOOTP 消息，客户端连接到网络时，首先要发现网络中的 DHCP 服务器，然后请求服务器：</p><p><img src="/images/ip/DHCPv4.png" alt=""></p><h5 id="discover"><a href="#discover" class="headerlink" title="discover"></a>discover</h5><p>一开始 client 使用 0 地址作为源，广播地址作为目标地址，去发现 DHCP 服务器：</p><p><img src="/images/ip/dhcp_discover.png" alt=""></p><h5 id="offer"><a href="#offer" class="headerlink" title="offer"></a>offer</h5><p>然后收到服务器的 offer 响应，这里可能有多个服务器，先收集所有信息。</p><p><img src="/images/ip/dhcp_offer.png" alt=""></p><p>注意大部分 offer 是以广播形式发送的，只不过我的电脑设置了单播，所以抓的包是单播形式。但是这里非常奇怪，为什么把还没正式分配的地址作为目标地址呢？如果网络中已经有一个 IP 地址为 10.0.0.51 的主机怎么办 ？这样为什么能够找到 client 主机呢？rfc 如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If the BROADCAST bit is cleared to 0, the message SHOULD be sent as an IP unicast to the IP address specified in the &apos;yiaddr&apos; field and the link-layer address specified in the &apos;chaddr&apos; field.</span><br></pre></td></tr></table></figure><p>但 rfc 回答了第一个问题。第二个问题，注意图中 offer 之前，服务器发送了一个 ARP 报文，这是在探测目前是否有主机使用了这个 IP 地址，通常是没有的，如果有，那么服务器会在 offer 中提供另一个 IP 地址。第三个问题，通过 Mac 地址找到 client，虽然此时 client IP 地址(0.0.0.0) 和 报文目标 IP 地址不同，不过 client 并不会丢弃这个报文（这很特殊）。</p><h5 id="request"><a href="#request" class="headerlink" title="request"></a>request</h5><p>offer 响应包含了服务器 可以提供的 IP 地址，client 从多个里面选取自己想要的（通常是以前使用过的），然后发送广播包请求：</p><p><img src="/images/ip/dhcp_request.png" alt=""></p><h5 id="ACK、NAK"><a href="#ACK、NAK" class="headerlink" title="ACK、NAK"></a>ACK、NAK</h5><p>服务器收到请求后，再次确认是否可以分配，然后响应 ACK 或 NAK 同意或不同意这个请求，如果发送 ACK，那么 client 就拥有了一个合法的 IP 地址，并且 client 发送 GARP 宣告自己的身份使得同网络的主机更新 ARP 缓存。</p><p>另外，client 从 ACK 中得到租用时间 T，计算出更新时间 T1=T/2，重新绑定时间 T2=7T/8.</p><h4 id="DHCP-状态机"><a href="#DHCP-状态机" class="headerlink" title="DHCP 状态机"></a>DHCP 状态机</h4><p><img src="/images/ip/dhcp_fsm.png" alt=""></p><h4 id="DHCPv6"><a href="#DHCPv6" class="headerlink" title="DHCPv6"></a>DHCPv6</h4><p>DHCPv6 过程和 DHCPv4 类似，消息类型和 DHCPv4 对应如下：</p><table><thead><tr><th style="text-align:center">DHCPv6</th><th>DHCPv4</th></tr></thead><tbody><tr><td style="text-align:center">SOLICIT</td><td>DISCOVER</td></tr><tr><td style="text-align:center">ADVERTISE</td><td>OFFER</td></tr><tr><td style="text-align:center">REQUEST</td><td>REQUEST</td></tr><tr><td style="text-align:center">RENEW</td><td>REQUEST</td></tr><tr><td style="text-align:center">REBIND</td><td>DISCOVER</td></tr><tr><td style="text-align:center">REPLY</td><td>ACK/NAK</td></tr><tr><td style="text-align:center">DECLINE</td><td>DECLINE</td></tr></tbody></table><p>略。</p><h3 id="DHCP-中继"><a href="#DHCP-中继" class="headerlink" title="DHCP 中继"></a>DHCP 中继</h3><p>以上 DHCP 服务有一个前提条件，就是服务器要和客户端在同一个网段，因为广播无法跨过路由器。如果一个企业有上百个部门，对应上百个子网，要配置上百个 DHCP 服务器。配置麻烦不说，而且资源分配可能不均衡，很可能出现一个部门地址不够分，另一个却有很多空闲。</p><p>所以需要统一管理分配，可是如何跨越广播域呢？可以通过一个中继来帮助客户端和服务器发现彼此。</p><h4 id="DHCP-中继代理"><a href="#DHCP-中继代理" class="headerlink" title="DHCP 中继代理"></a>DHCP 中继代理</h4><p>当DHCP客户端与服务器不在同一个子网上，就必须有DHCP中继代理来转发DHCP请求和应答消息。DHCP中继代理的数据转发，与通常路由转发是不同的，通常的路由转发相对来说是透明传输的，设备一般不会修改IP包内容。而DHCP中继代理接收到DHCP消息后，进行<strong>转换源目的IP，MAC</strong>生成一个DHCP消息，然后转发出去。</p><p>在DHCP客户端看来，DHCP中继代理就像DHCP服务器；在DHCP服务器看来，DHCP中继代理就像DHCP客户端。</p><p>不需要在各个用户网关设备上启用DHCP server功能，而只要在网络中心安装一个 DHCP 服务器，就可以实现对多个网段的动态IP管理，统一维护，即Client—Relay—Server 模式的DHCP动态IP管理</p><ul><li>当dhcp client 启动并进行dhcp 初始化时，它会在本地网络广播配置请求报文。</li><li>如果本地网络存在 dhcp server，则可以直接进行 dhcp 配置，不需要 dhcp relay。</li><li>如果本地网络没有 dhcp server，则与本地网络相连的具有 dhcprelay 功能的网络设备收到该广播报文后，将进行适当处理并转发给指定的其它网络上的 dhcp server。</li><li>dhcp server 根据 dhcp client 提供的信息进行相应的配置，并通过 dhcp relay 将配置信息发送给 dhcp client，完成对dhcp client 的动态配置。</li></ul><h3 id="无状态地址自动配置"><a href="#无状态地址自动配置" class="headerlink" title="无状态地址自动配置"></a>无状态地址自动配置</h3><p>对于一个全球性的地址，这些地址的某一部分通常需要被管理，也就是通过 DHCP 动态分配的。但如果只是<a href="https://zh.wikipedia.org/wiki/%E9%93%BE%E8%B7%AF%E6%9C%AC%E5%9C%B0%E5%9C%B0%E5%9D%80" target="_blank" rel="noopener">链路本地</a>的地址，通常通过<em>自动配置</em>来获得，也就是主机自己决定自己的 IP 地址。称为<em>无状态地址自动配置</em>（SLAAC）。</p><h4 id="IPv4-链路本地的动态配置"><a href="#IPv4-链路本地的动态配置" class="headerlink" title="IPv4 链路本地的动态配置"></a>IPv4 链路本地的动态配置</h4><p>当一个网络没有 DHCP 服务器和中继，主机不能获取 IP 地址，那么只能自己分配一个链路本地地址。IPv4 链路本地的范围是 168.254.0.1~168.254.254.254，使用子网掩码 255.255.0.0。</p><p>这种方法也叫自动专用 IP 寻址（Auto Private IP Addressing）。就是从特定范围随机选择一个地址，然后通过 GARP 检查是否有冲突。</p><h4 id="链路本地-IPv6-的-SLAAC"><a href="#链路本地-IPv6-的-SLAAC" class="headerlink" title="链路本地 IPv6 的 SLAAC"></a>链路本地 IPv6 的 SLAAC</h4><p>无状态地址自动配置（StateLess Address Auto Config，SLAAC）可用于无路由器环境，只分配链路本地地址。IPv6 的链路本地地址以 fe80::/10 为前缀，最后 N 位是一个<em>接口 ID（IID）</em>，其余位为 0。IID 可以通过主机的 Mac 地址按照一定的规则来生成，也可以是一个随机数，基本可以保证局域网中的唯一性。</p><p><img src="/images/ip/ipv6_link_local.png" alt=""></p><p>由于没有路由器，这个地址只能在子网内部使用，不可路由。</p><h4 id="全球地址的-IPv6-SLAAC"><a href="#全球地址的-IPv6-SLAAC" class="headerlink" title="全球地址的 IPv6 SLAAC"></a>全球地址的 IPv6 SLAAC</h4><p>一个节点获得链路本地地址后，还可能需要一个或多个全球地址。全球地址的形成类似于链路本地地址，只不过前缀不再是 fe80::/10，而是由路由器给出的可以路由的前缀。</p><p><img src="/images/ip/ipv6_global.png" alt=""></p><h4 id="无状态-DHCP"><a href="#无状态-DHCP" class="headerlink" title="无状态 DHCP"></a>无状态 DHCP</h4><p>无状态 DHCP 模式下， DHCPv6 提供 IP 地址以外的其他信息。在分配 IP 地址时，需要维护 IP 地址的租用状态（见前面的 DHCP 状态机），如果不提供 IP 地址，那么也就不用维护状态，故称无状态 DHCP。</p><p>通常把 IPv6 全球地址 SLAAC 和无状态 DHCP 结合起来用。</p><h3 id="相关攻击"><a href="#相关攻击" class="headerlink" title="相关攻击"></a>相关攻击</h3><p>最大的漏洞就是如果有恶意主机，冒充正常主机，不断使用伪造的 Mac 地址来申请 IP 地址，那么 IP 地址资源很快用尽。可以采用授权的方式，使得合法的请求才能获取 IP 地址，同时限制未授权用户的数量，像链路层认证（如 WIFI 网络使用的 WPA2）就有助于限制未授权客户机的数量。</p><div class="post-announce">Thank you for reading, this article belongs to <a href="http://littlechao.top">Hexo</a> copyright, if reproduced, please indicate the source：Hexo（<a href="http://littlechao.top/2018/06/17/dhcp/">http://littlechao.top/2018/06/17/dhcp/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2018/06/15/go_sdk_runtime_string/" title="Go String 笔记"><i class="iconfont icon-prev"></i>Go String 笔记</a></div><div class="post__prev post__prev--right"></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">Introduction</h3><p class="block__text">日常学习与兴趣交流的个人博客</p></div><div class="sidebar__block"><h3 class="block__title">Categories</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/network-protocol/">network protocol</a><span class="block-list-count">10</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/netstack-tcp/">netstack_tcp</a><span class="block-list-count">4</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/go-sdk/">go sdk</a><span class="block-list-count">5</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">Latest Post</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/06/17/dhcp/" title="DHCP 和自动配置"><div class="item__cover"><img src="/images/ip/ip.jpg" alt="DHCP 和自动配置"></div><div class="item__info"><h3 class="item__title">DHCP 和自动配置</h3><span class="item__text">2018-06-17</span></div></a></li><li class="latest-post-item"><a href="/2018/06/15/go_sdk_runtime_string/" title="Go String 笔记"><div class="item__cover"><img src="https://image.littlechao.top/20180301160118000011.jpg" alt="Go String 笔记"></div><div class="item__info"><h3 class="item__title">Go String 笔记</h3><span class="item__text">2018-06-15</span></div></a></li><li class="latest-post-item"><a href="/2018/06/12/arp/" title="ARP 地址解析协议"><div class="item__cover"><img src="/images/ip/ip.jpg" alt="ARP 地址解析协议"></div><div class="item__info"><h3 class="item__title">ARP 地址解析协议</h3><span class="item__text">2018-06-12</span></div></a></li><li class="latest-post-item"><a href="/2018/06/10/internet_protocol/" title="IP(II) 协议"><div class="item__cover"><img src="/images/ip/ip.jpg" alt="IP(II) 协议"></div><div class="item__info"><h3 class="item__title">IP(II) 协议</h3><span class="item__text">2018-06-10</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">Tags</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/IP/">IP</a></li><li class="tag-item"><a class="tag-link" href="/tags/Intellij/">Intellij</a></li><li class="tag-item"><a class="tag-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-item"><a class="tag-link" href="/tags/dart/">dart</a></li><li class="tag-item"><a class="tag-link" href="/tags/golang/">golang</a></li><li class="tag-item"><a class="tag-link" href="/tags/net/">net</a></li><li class="tag-item"><a class="tag-link" href="/tags/netstack/">netstack</a></li><li class="tag-item"><a class="tag-link" href="/tags/node/">node</a></li><li class="tag-item"><a class="tag-link" href="/tags/react/">react</a></li><li class="tag-item"><a class="tag-link" href="/tags/redux/">redux</a></li><li class="tag-item"><a class="tag-link" href="/tags/tcp/">tcp</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Baoding, Hebei Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>shichao1996@gmail.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="https://image.littlechao.top/20180512113439000006.jpg" alt="logo" title="Hexo"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.</p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>