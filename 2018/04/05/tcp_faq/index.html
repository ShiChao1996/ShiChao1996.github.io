<!DOCTYPE html><html><head><meta charset="utf-8"><title>TCP 疑难杂症 | LOVAE BLOG</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="Lovae"><meta name="designer" content="minfive"><meta name="keywords" content="lovae, shichao blog, 前端博客, 前端, 程序员, 前端开发, 全栈开发, node.js, javascript, 后台, golang, 网络编程"><meta name="description" content="日常学习与兴趣交流的个人博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://littlechao.top/2018/04/05/tcp_faq/index.html"><link rel="icon" type="image/png" href="https://image.littlechao.top/20180512113931000007.jpg" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="Hexo"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(http://oo12ugek5.bkt.clouddn.com/blog/images/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="Hexo" alt="Hexo"><img src="https://image.littlechao.top/20180506131200000003.jpg" alt="Hexo"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archive" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/images/tcp/faq.jpg" alt="TCP 疑难杂症"></div><header class="post__info"><h1 class="post__title">TCP 疑难杂症</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">Lovae</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-04-05</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/tcp/">Tcp</a></li></ul></div></div></header><div class="post__content"><h2 id="TCP-的一些问题与解答"><a href="#TCP-的一些问题与解答" class="headerlink" title="TCP 的一些问题与解答"></a>TCP 的一些问题与解答</h2><h4 id="TCP-连接的初始化序列号能否固定"><a href="#TCP-连接的初始化序列号能否固定" class="headerlink" title="TCP 连接的初始化序列号能否固定"></a>TCP 连接的初始化序列号能否固定</h4><p>如果初始化序列号（缩写为ISN：Inital Sequence Number）可以固定，我们来看看会出现什么问题：</p><ul><li>假设ISN固定是1，Client和Server建立好一条TCP连接后，Client连续给Server发了10个包，这10个包不知怎么被链路上的路由器缓存了(路由器会毫无先兆地缓存或者丢弃任何的数据包)，这个时候碰巧Client挂掉了；</li><li>然后Client用同样的端口号重新连上Server，Client又连续给Server发了几个包，假设这个时候Client的序列号变成了5；</li><li>接着，之前被路由器缓存的10个数据包全部被路由到Server端了，Server给Client回复确认号10，这个时候，Client整个都不好了，这是什么情况？我的序列号才到5，你怎么给我的确认号是10了，整个都乱了。</li></ul><p>RFC793](<a href="https://tools.ietf.org/html/rfc793)中，建议ISN和一个假的时钟绑在一起，这个时钟会在每4微秒对" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc793)中，建议ISN和一个假的时钟绑在一起，这个时钟会在每4微秒对</a> ISN 做加一操作，直到超过2^32，又从0开始，这需要4小时才会产生 ISN 的回绕问题，这几乎可以保证每个新连接的ISN不会和旧的连接的 ISN 产生冲突。这种递增方式的 ISN，很容易让攻击者猜测到TCP连接的ISN，现在的实现大多是在一个基准值的基础上进行随机的。</p><h4 id="初始化连接的-SYN-超时问题"><a href="#初始化连接的-SYN-超时问题" class="headerlink" title="初始化连接的 SYN 超时问题"></a>初始化连接的 SYN 超时问题</h4><p>Client发送SYN包给Server后挂了，Server 回给 Client 的 SYN-ACK 一直没收到 Client 的 ACK 确认，这个时候这个连接既没建立起来，也不能算失败。这就需要一个超时时间让 Server 将这个连接断开，否则这个连接就会一直占用Server的SYN连接队列中的一个位置，大量这样的连接就会将Server的 SYN 连接队列耗尽，让正常的连接无法得到处理。</p><p>目前，Linux下默认会进行5次重发SYN-ACK包，重试的间隔时间从1s开始，下次的重试间隔时间是前一次的双倍，5次的重试时间间隔为1s, 2s, 4s, 8s, 16s，总共31s，第5次发出后还要等32s都知道第5次也超时了.所以，总共需要 63s，TCP才会把断开这个连接。</p><p>由于，SYN 超时需要63秒，那么就给攻击者一个攻击服务器的机会，攻击者在短时间内发送大量的SYN包给Server(俗称 SYN flood 攻击)，用于耗尽Server的SYN队列。对于应对SYN 过多的问题，linux提供了几个TCP参数：tcp_syncookies、tcp_synack_retries、tcp_max_syn_backlog、tcp_abort_on_overflow 来调整应对。</p><h4 id="TIME-WAIT-状态"><a href="#TIME-WAIT-状态" class="headerlink" title="TIME_WAIT 状态"></a>TIME_WAIT 状态</h4><p><code>TIME_WAIT</code>状态是TCP连接中<strong>主动关闭</strong>连接的一方会进入的状态，在发出最后一个 ACK 包之后，主动关闭方进入 <code>TIME_WAIT</code> 状态，从而确保 ACK 包到达对端，以及等待网络中之前迷路的数据包完全消失，防止端口被复用的时候收到迷路包从而出现收包错误。</p><p><code>TIME_WAIT</code> 状态会持续 2MSL（max segment lifetime）的时间，一般 1 分钟到 4 分钟。在这段时间内端口不能被重新分配使用。</p><p><img src="./images/four_shakes.png" alt=""></p><p>Linux 上使用 <code>sysctl -a | grep time | grep wait</code> 命令查看如下：</p><p><img src="./images/msl.png" alt=""></p><h5 id="TIME-WAIT会带来哪些问题呢？"><a href="#TIME-WAIT会带来哪些问题呢？" class="headerlink" title="TIME_WAIT会带来哪些问题呢？"></a>TIME_WAIT会带来哪些问题呢？</h5><ul><li>作为服务器，短时间内关闭了大量的 Client 连接，就会造成服务器上出现大量的TIME_WAIT连接，占据大量的tuple，严重消耗着服务器的资源；</li><li>作为客户端，短时间内大量的短连接，会大量消耗的Client机器的端口，毕竟端口只有65535个，端口被耗尽了，后续就无法在发起新的连接了。</li></ul><h5 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h5><p>服务端为了解决这个 TIME_WAIT 问题，可选的方式有3种：</p><ul><li>保证由客户端主动发起关闭</li><li>关闭的时候使用 RST 方式（set SO_LINGER）</li><li>对处于 TIME_WAIT 状态的 TPC 允许重用（set SO_REUSEADDR），设置TCP参数 net.ipv4.tcp_tw_reuse = 1 和 net.ipv4.tcp_tw_recycle = 1。注意：使用tcp_tw_reuse和tcp_tw_recycle解决TIME_WAIT过多问题是非常危险的，参考<a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="noopener">RFC</a></li></ul><div class="post-announce">感谢您的阅读，本文由 <a href="http://littlechao.top">Hexo</a> 版权所有。如若转载，请注明出处：Hexo（<a href="http://littlechao.top/2018/04/05/tcp_faq/">http://littlechao.top/2018/04/05/tcp_faq/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2018/04/03/tcp_keepalive/" title="TCP 保活机制"><i class="iconfont icon-prev"></i>TCP 保活机制</a></div><div class="post__prev post__prev--right"><a href="/2018/04/15/intellij 自定义注释/" title="Intellij 自定义注释">Intellij 自定义注释<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">日常学习与兴趣交流的个人博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/网络/">网络</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/netstack-tcp/">netstack_tcp</a><span class="block-list-count">4</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2018/05/17/netstack_tcp_receive/" title="netstack TCP(IV) 收发数据(下)"><div class="item__cover"><img src="/images/netstack/cover.jpg" alt="netstack TCP(IV) 收发数据(下)"></div><div class="item__info"><h3 class="item__title">netstack TCP(IV) 收发数据(下)</h3><span class="item__text">2018-05-17</span></div></a></li><li class="latest-post-item"><a href="/2018/05/15/netstack_tcp_send/" title="netstack TCP(III) 收发数据(上)"><div class="item__cover"><img src="/images/netstack/cover.jpg" alt="netstack TCP(III) 收发数据(上)"></div><div class="item__info"><h3 class="item__title">netstack TCP(III) 收发数据(上)</h3><span class="item__text">2018-05-15</span></div></a></li><li class="latest-post-item"><a href="/2018/05/07/netstack_linklayer/" title="Netstack(II) 链路层"><div class="item__cover"><img src="/images/netstack/cover.jpg" alt="Netstack(II) 链路层"></div><div class="item__info"><h3 class="item__title">Netstack(II) 链路层</h3><span class="item__text">2018-05-07</span></div></a></li><li class="latest-post-item"><a href="/2018/04/20/netstack_conn_handshake/" title="netstack TCP(II) 连接管理与三次握手"><div class="item__cover"><img src="/images/netstack/cover.jpg" alt="netstack TCP(II) 连接管理与三次握手"></div><div class="item__info"><h3 class="item__title">netstack TCP(II) 连接管理与三次握手</h3><span class="item__text">2018-04-20</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Intellij/">Intellij</a></li><li class="tag-item"><a class="tag-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-item"><a class="tag-link" href="/tags/dart/">dart</a></li><li class="tag-item"><a class="tag-link" href="/tags/golang/">golang</a></li><li class="tag-item"><a class="tag-link" href="/tags/net/">net</a></li><li class="tag-item"><a class="tag-link" href="/tags/netstack/">netstack</a></li><li class="tag-item"><a class="tag-link" href="/tags/node/">node</a></li><li class="tag-item"><a class="tag-link" href="/tags/react/">react</a></li><li class="tag-item"><a class="tag-link" href="/tags/redux/">redux</a></li><li class="tag-item"><a class="tag-link" href="/tags/tcp/">tcp</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Baoding, Hebei Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>shichao1996@gmail.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="https://image.littlechao.top/20180512113439000006.jpg" alt="logo" title="Hexo"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>